# Подход к веб-скрапингу 2GIS

**Дата создания:** 2026-02-12  
**Последнее обновление:** 2026-02-13

## Обоснование подхода

Вместо использования официального API 2GIS (который требует регистрации и API ключа), мы используем веб-скрапинг публично доступных страниц сайта 2gis.ru. Данные на сайте доступны публично и индексируются поисковыми системами, что делает их доступными для извлечения.

## Структура URL на 2GIS

### Поиск компаний
```
https://2gis.ru/[city]/search/[query]
https://2gis.ru/[city]/search/[category]
```

Примеры:
- `https://2gis.ru/moscow/search/кафе`
- `https://2gis.ru/spb/search/рестораны`
- `https://2gis.ru/ekb/search/салоны красоты`

### Страница компании
```
https://2gis.ru/[city]/firm/[id]
```

Пример:
- `https://2gis.ru/moscow/firm/70000001031668425`

## Технический подход

### 1. Использование Selenium
- **Причина:** Страницы 2GIS используют JavaScript для динамической загрузки контента
- **Подход:** Selenium автоматизирует браузер для загрузки полного контента страницы
- **Настройки:** Headless режим для работы без GUI

### 2. Парсинг с BeautifulSoup
- **Причина:** После загрузки JavaScript контента, HTML можно парсить статически
- **Подход:** Извлечение данных из структурированного HTML
- **Селекторы:** Использование CSS селекторов и классов для поиска элементов

### 3. Извлечение данных

**Структура данных на странице поиска:**
- Список компаний в контейнерах с определенными классами
- Каждая компания содержит: название, адрес, рейтинг, ссылку на страницу

**Структура данных на странице компании:**
- Полная информация: название, телефон, адрес, рейтинг, количество отзывов, описание

## Алгоритм работы

1. **Формирование URL поиска:**
   - Преобразование города в URL-формат (например, "Москва" → "moscow")
   - Формирование URL: `https://2gis.ru/{city}/search/{category}`

2. **Загрузка страницы поиска:**
   - Использование Selenium для загрузки страницы
   - Ожидание загрузки JavaScript контента
   - Получение HTML страницы

3. **Парсинг результатов поиска:**
   - Поиск контейнеров с компаниями
   - Извлечение ссылок на страницы компаний
   - Обработка пагинации (если есть)

4. **Загрузка страниц компаний:**
   - Для каждой компании загружается отдельная страница
   - Извлечение полной информации о компании

5. **Извлечение данных:**
   - Название компании
   - Телефон
   - Адрес (в колонку «Адрес»; не попадает в «Информация»)
   - Рейтинг
   - Количество голосов/отзывов
   - Описание/информация о компании (только описание, без адреса)

**Разделение адреса и описания:** На 2GIS адрес и описание могут быть в одном блоке. Метод `_extract_address_and_info` извлекает адрес по ключевым словам (ул., пр., бульвар и т.д.), при необходимости разделяет блок по маркерам описания (предлагаем, работаем и т.д.), и гарантирует, что адрес сохраняется в поле address, а описание — в info.

## Обработка особенностей

### Пагинация
- Определение наличия следующей страницы
- Переход на следующую страницу результатов
- Сбор всех результатов

### Динамическая загрузка
- Ожидание загрузки контента через WebDriverWait
- Проверка наличия элементов перед парсингом
- Retry логика при неудачных загрузках

### Анти-скрапинг меры
- Использование реалистичных User-Agent
- Задержки между запросами (2-3 секунды)
- Ротация заголовков
- Обработка капч (если появится)

## Преимущества подхода

1. **Не требует API ключа** - данные публично доступны
2. **Актуальные данные** - получаем данные напрямую с сайта
3. **Полный доступ** - нет ограничений демо-ключей
4. **Гибкость** - можем извлекать любые данные, видимые на странице

## Ограничения и риски

1. **Изменения структуры сайта** - 2GIS может изменить HTML структуру
2. **Блокировки** - слишком частые запросы могут привести к блокировке
3. **Производительность** - скрапинг медленнее чем API
4. **Зависимость от браузера** - требуется установленный Chrome/Firefox

## Меры предосторожности

1. **Задержки между запросами:** 2-3 секунды минимум
2. **Обработка ошибок:** Graceful handling всех возможных ошибок
3. **Логирование:** Подробное логирование для отладки
4. **Валидация данных:** Проверка извлеченных данных перед экспортом
